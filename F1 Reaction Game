<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>F1 Reaction Game</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: url('https://i.imgur.com/84zZf6N.jpg') no-repeat center center/cover;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .lights {
      display: grid;
      grid-template-columns: repeat(5, 50px);
      grid-template-rows: repeat(5, 50px);
      gap: 10px;
      margin: 20px;
    }
    .light {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #333;
      border: 2px solid #555;
    }
    .light.on {
      background: red;
    }
    #message {
      margin-top: 20px;
      font-size: 1.2em;
      text-shadow: 2px 2px 4px #000;
    }
    #history {
      margin-top: 20px;
      font-size: 0.9em;
    }
    #average, #best, #leaderboard {
      margin-top: 10px;
      font-size: 1em;
    }
    #average {
      color: #0f0;
    }
    #best {
      color: #ff0;
    }
    #leaderboard {
      color: #0ff;
    }
    #nicknameInput {
      margin-bottom: 15px;
      padding: 5px;
      font-size: 1em;
    }
    #shareBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>F1 Reaction Game</h1>
  <input type="text" id="nicknameInput" placeholder="輸入你的暱稱" />
  <div class="lights" id="lights"></div>
  <button id="startBtn">開始遊戲</button>
  <div id="message"></div>
  <div id="history"></div>
  <div id="average"></div>
  <div id="best"></div>
  <div id="leaderboard"></div>
  <button id="shareBtn" style="display:none;">分享成績</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const startBtn = document.getElementById("startBtn");
    const lightsContainer = document.getElementById("lights");
    const message = document.getElementById("message");
    const historyDiv = document.getElementById("history");
    const averageDiv = document.getElementById("average");
    const bestDiv = document.getElementById("best");
    const leaderboardDiv = document.getElementById("leaderboard");
    const shareBtn = document.getElementById("shareBtn");
    const nicknameInput = document.getElementById("nicknameInput");

    let startTime;
    let waiting = false;
    let results = [];
    let lights = [];

    // 動態建立 5x5 燈號
    function createLights() {
      lightsContainer.innerHTML = "";
      lights = [];
      for (let i = 0; i < 25; i++) {
        let div = document.createElement("div");
        div.classList.add("light");
        lightsContainer.appendChild(div);
        lights.push(div);
      }
    }

    function resetLights() {
      lights.forEach(light => light.classList.remove("on"));
    }

    function startGame() {
      resetLights();
      message.textContent = "燈號準備中... 請等待";
      startBtn.disabled = true;
      let i = 0;

      let interval = setInterval(() => {
        if (i < lights.length) {
          lights[i].classList.add("on");
          i++;
        } else {
          clearInterval(interval);
          setTimeout(() => {
            resetLights();
            message.textContent = "燈號熄滅！快按下空白鍵或點擊螢幕！";
            startTime = Date.now();
            waiting = true;
          }, Math.random() * 2000 + 1000); // 1~3秒隨機熄滅
        }
      }, 150);
    }

    function endGame() {
      if (!waiting) return;
      let reaction = Date.now() - startTime;
      waiting = false;
      results.push(reaction);
      let nickname = nicknameInput.value || "玩家";
      message.textContent = `${nickname} 的反應時間: ${reaction} ms - ${getComment(reaction)}`;
      updateHistory();
      updateAverage();
      updateBest();
      updateLeaderboard();
      shareBtn.style.display = "inline-block";
      startBtn.disabled = false;
    }

    function getComment(ms) {
      if (ms < 200) return "你有成為賽車手的潛力!!";
      if (ms < 300) return "不錯！反應很快！";
      if (ms < 400) return "普通水準，加油！";
      if (ms < 600) return "稍慢了，要更專注！";
      return "太慢了，再試一次！";
    }

    function updateHistory() {
      historyDiv.innerHTML = "<b>歷史紀錄:</b><br>" + results.map((r,i)=> `第${i+1}次: ${r} ms`).join("<br>");
    }

    function updateAverage() {
      let sum = results.reduce((a,b)=>a+b,0);
      let avg = Math.round(sum / results.length);
      averageDiv.textContent = `平均反應時間: ${avg} ms`;
    }

    function updateBest() {
      let best = Math.min(...results);
      bestDiv.textContent = `最佳反應時間: ${best} ms`;
    }

    function updateLeaderboard() {
      let sorted = [...results].sort((a,b)=>a-b).slice(0,3);
      const titles = ["閃電手 ⚡", "飛車手 🏎️", "賽道王 🏁"];
      leaderboardDiv.innerHTML = "<b>排行榜 (前3名):</b><br>" + sorted.map((r,i)=> `第${i+1}名 (${titles[i]}): ${r} ms`).join("<br>");
    }

    shareBtn.addEventListener("click", () => {
      let nickname = nicknameInput.value || "玩家";
      html2canvas(document.body, {width:1280, height:720}).then(canvas => {
        let link = document.createElement("a");
        link.download = `${nickname}_reaction_result.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    startBtn.addEventListener("click", startGame);
    document.body.addEventListener("keydown", e => { if (e.code === "Space") endGame(); });
    document.body.addEventListener("click", endGame);

    // 初始化建立燈號
    createLights();
  </script>
</body>
</html>
