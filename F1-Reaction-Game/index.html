<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F1 Reaction Game</title>
  <style>
    :root{ --glass: rgba(0,0,0,.55); }
    *{ box-sizing: border-box; }
    body{
      margin:0; padding:0;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      min-height:100vh;
      background:url('https://tse2.mm.bing.net/th/id/OIP.dAkJCNoqGuYsy2vao-Lw6wHaE8?pid=Api') no-repeat center/cover;
      font-family: Arial, system-ui, -apple-system, Segoe UI, PingFang TC, sans-serif;
      color:#fff; text-align:center;
    }
    h1{ margin:18px 0 8px; text-shadow:0 3px 10px #000; }
    .panel{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; background:var(--glass); padding:10px 12px; border-radius:12px; }
    select, button, input{ padding:8px 10px; border-radius:8px; border:none; }

    /* åŠæ›å¼ç‡ˆè™Ÿå€ */
    .lights{ display:flex; flex-direction:row; gap:12px; margin:16px 0; padding:16px; background:var(--glass); border-radius:12px; }
    .col{ display:flex; flex-direction:column; gap:12px; }
    .light{ width:44px; height:44px; border-radius:50%; background:#333; border:2px solid #555; box-shadow:0 0 8px #000 inset; transition:background .12s, box-shadow .12s; }
    .light.on{ background:#e10600; box-shadow:0 0 16px #ff2a2a; }
    .light.go{ background:#00d26a; box-shadow:0 0 18px #00ff8a; }

    #message{ min-height:28px; text-shadow:0 2px 6px #000; }

    /* è³‡è¨Šæ¿ */
    #boards{ width:min(1100px,95vw); display:grid; grid-template-columns:repeat(3,minmax(220px,1fr)); gap:12px; }
    #history, #average, #best, #leaderboard, #tripleSummary, #rankList{
      background:var(--glass); padding:12px; border-radius:10px; text-align:left;
    }
    #average{ color:#8dffa6; } #best{ color:#ffe66d; } #leaderboard{ color:#8feaff; }
    .fs{ color:#ff6b6b; font-weight:700; }

    /* åˆ†äº«åœ–å¡æ¨£å¼ */
    #shareCardWrapper{ position:absolute; left:-99999px; top:0; }
    .share-card{ position:relative; width:1080px; height:1920px; display:flex; flex-direction:column; justify-content:space-between; color:#fff; padding:60px; background-image:inherit; background-position:center; background-size:cover; }
    .share-top{ display:flex; align-items:center; gap:20px; }
    .share-lights{ display:flex; gap:10px; }
    .share-light{ width:40px; height:40px; border-radius:50%; background:#e10600; box-shadow:0 0 12px rgba(255,0,0,.85); border:2px solid #550000; }
    .share-title{ font-size:56px; font-weight:800; text-shadow:2px 2px 8px #000; }
    .share-mid{ background:rgba(0,0,0,.5); padding:30px; border-radius:18px; }
    .share-big{ font-size:120px; font-weight:900; line-height:1.1; }
    .share-sub{ font-size:34px; opacity:.95; }
    .share-rank{ font-size:40px; margin-top:10px; }
    .ranklist-box{ background:rgba(0,0,0,.35); padding:20px; border-radius:14px; margin-top:20px; font-size:28px; line-height:1.6; }
    .share-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:20px; }
    .share-box{ background:rgba(255,255,255,.06); padding:16px 20px; border-radius:14px; }
    .share-foot{ display:flex; justify-content:space-between; align-items:flex-end; font-size:28px; opacity:.9; gap:12px; flex-wrap:wrap; }
    .checker{ height:40px; background:repeating-linear-gradient(90deg,#fff 0 40px,#000 40px 80px); border-radius:10px; flex:1; }
  </style>
</head>
<body>
  <h1>F1 Reaction Game</h1>

  <div class="panel">
    <input type="text" id="nicknameInput" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" />
    <label>é›£åº¦ï¼š
      <select id="difficulty">
        <option value="easy">ç°¡å–®</option>
        <option value="normal" selected>æ™®é€š</option>
        <option value="hard">å›°é›£</option>
      </select>
    </label>
    <label>åˆ†äº«å°ºå¯¸ï¼š
      <select id="shareSize">
        <option value="1080x1920" selected>IG é™æ™‚å‹•æ…‹ (1080Ã—1920)</option>
        <option value="1080x1350">IG/è„† è²¼æ–‡ 4:5 (1080Ã—1350)</option>
        <option value="1080x1080">æ­£æ–¹å½¢ 1:1 (1080Ã—1080)</option>
      </select>
    </label>
    <button id="startBtn">é–‹å§‹éŠæˆ²</button>
    <button id="tripleBtn">ä¸‰é€£æŒ‘æˆ°</button>
    <button id="shareBtn" style="display:none;">åˆ†äº«æˆç¸¾</button>
    <button id="resetBtn" title="æ¸…é™¤æœ¬åœ°æˆç¸¾">æ¸…é™¤è³‡æ–™</button>
  </div>

  <div class="lights" id="lights"></div>
  <div id="message"></div>

  <div id="boards">
    <div id="history"></div>
    <div id="average"></div>
    <div id="best"></div>
    <div id="leaderboard"></div>
    <div id="tripleSummary"></div>
    <div id="rankList"></div>
  </div>

  <!-- éš±è—çš„åˆ†äº«å¡ç‰‡å®¹å™¨ -->
  <div id="shareCardWrapper"></div>

  <!-- éŸ³æ•ˆ -->
  <audio id="startSound" src="https://actions.google.com/sounds/v1/transportation/car_engine_start.ogg" preload="auto"></audio>
  <audio id="goSound" src="https://actions.google.com/sounds/v1/transportation/race_car_passing.ogg" preload="auto"></audio>
  <audio id="falseStartSound" src="https://actions.google.com/sounds/v1/cartoon/metal_clang.ogg" preload="auto"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ======== DOM åƒç…§ ========
    const lightsContainer = document.getElementById('lights');
    const message = document.getElementById('message');
    const historyDiv = document.getElementById('history');
    const averageDiv = document.getElementById('average');
    const bestDiv = document.getElementById('best');
    const leaderboardDiv = document.getElementById('leaderboard');
    const tripleSummary = document.getElementById('tripleSummary');
    const rankListDiv = document.getElementById('rankList');

    const nicknameInput = document.getElementById('nicknameInput');
    const difficultySel = document.getElementById('difficulty');
    const startBtn = document.getElementById('startBtn');
    const tripleBtn = document.getElementById('tripleBtn');
    const shareBtn = document.getElementById('shareBtn');
    const resetBtn = document.getElementById('resetBtn');

    const shareSizeSel = document.getElementById('shareSize');
    const shareCardWrapper = document.getElementById('shareCardWrapper');

    const startSound = document.getElementById('startSound');
    const goSound = document.getElementById('goSound');
    const falseStartSound = document.getElementById('falseStartSound');

    // ======== éŠæˆ²ç‹€æ…‹ ========
    let results = [];         // æœ‰æ•ˆæˆç¸¾ (ms)
    let attempts = [];        // { type:'time'|'fs', value?:ms }

    let waiting = false;      // true = å·²ç¶“ GOï¼Œå¯çµç®—
    let gameActive = false;   // true = ç‡ˆè™Ÿæµç¨‹ä¸­ï¼Œå¯åˆ¤æ¶è·‘

    let columns = [];         // 5 åˆ— Ã— æ¯åˆ— 4 ç‡ˆ

    // ä¸‰é€£æŒ‘æˆ°
    let tripleMode = false;
    let tripleBuffer = [];

    // è¨ˆæ™‚å™¨ IDs
    let buildInterval = null, preGoTimeout = null, flashInterval = null;

    // é›£åº¦åƒæ•¸
    const DIFF = {
      easy:   { colInterval: 1000, delayMin: 1000, delayMax: 3000 },
      normal: { colInterval: 700,  delayMin: 800,  delayMax: 2000 },
      hard:   { colInterval: 500,  delayMin: 500,  delayMax: 1500 }
    };

    // LocalStorage
    const LS_KEY = 'f1rx_data_v2';

    function loadLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY); if(!raw) return;
        const obj = JSON.parse(raw);
        results = Array.isArray(obj.results)? obj.results: [];
        attempts = Array.isArray(obj.attempts)? obj.attempts: [];
        if (obj.nickname) nicknameInput.value = obj.nickname;
        if (obj.difficulty && DIFF[obj.difficulty]) difficultySel.value = obj.difficulty;
      }catch(e){}
    }
    function saveLocal(){
      const obj = { results, attempts, nickname: nicknameInput.value||'', difficulty: difficultySel.value };
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }

    // ======== æ®µä½/è©•èª ========
    function getComment(ms){
      if (ms < 200) return 'ä½ æœ‰æˆç‚ºè³½è»Šæ‰‹çš„æ½›åŠ›!!';
      if (ms < 300) return 'ä¸éŒ¯ï¼åæ‡‰å¾ˆå¿«ï¼';
      if (ms < 400) return 'æ™®é€šæ°´æº–ï¼ŒåŠ æ²¹ï¼';
      if (ms < 600) return 'ç¨æ…¢äº†ï¼Œè¦æ›´å°ˆæ³¨ï¼';
      return 'å¤ªæ…¢äº†ï¼Œå†è©¦ä¸€æ¬¡ï¼';
    }
    function getRank(ms){
      if (ms < 200) return { title:'é–ƒé›»æ‰‹', badge:'âš¡' };
      if (ms < 300) return { title:'é£›è»Šæ‰‹', badge:'ğŸï¸' };
      if (ms < 400) return { title:'å°ˆæ³¨è€…', badge:'ğŸ¯' };
      if (ms < 600) return { title:'æ–°æ‰‹', badge:'ğŸš¦' };
      return { title:'æ…¢åŠæ‹', badge:'ğŸ¢' };
    }
    function updateRankList(){
      rankListDiv.innerHTML = `<b>æ®µä½åˆ—è¡¨ï¼š</b><br>
      âš¡ é–ƒé›»æ‰‹ï¼š<200ms<br>
      ğŸï¸ é£›è»Šæ‰‹ï¼š200â€“299ms<br>
      ğŸ¯ å°ˆæ³¨è€…ï¼š300â€“399ms<br>
      ğŸš¦ æ–°æ‰‹ï¼š400â€“599ms<br>
      ğŸ¢ æ…¢åŠæ‹ï¼šâ‰¥600ms`;
    }

    // ======== UI æ¿æ›´æ–° ========
    function updateHistory(){
      const lines = attempts.map((a,i)=> a.type==='fs' ? `ç¬¬${i+1}æ¬¡ï¼š<span class="fs">æ¶è·‘</span>` : `ç¬¬${i+1}æ¬¡ï¼š${a.value} ms`);
      historyDiv.innerHTML = `<b>æ­·å²ç´€éŒ„:</b><br>${lines.join('<br>')}`;
    }
    function updateAverage(){
      if (!results.length){ averageDiv.textContent = 'å¹³å‡åæ‡‰æ™‚é–“: -'; return; }
      const avg = Math.round(results.reduce((a,b)=>a+b,0) / results.length);
      averageDiv.textContent = `å¹³å‡åæ‡‰æ™‚é–“: ${avg} ms`;
    }
    function updateBest(){
      if (!results.length){ bestDiv.textContent = 'æœ€ä½³åæ‡‰æ™‚é–“: -'; return; }
      const best = Math.min(...results);
      bestDiv.textContent = `æœ€ä½³åæ‡‰æ™‚é–“: ${best} ms`;
    }
    function updateLeaderboard(){
      if (!results.length){ leaderboardDiv.textContent = 'æ’è¡Œæ¦œ (å‰3å): -'; return; }
      const sorted = [...results].sort((a,b)=>a-b).slice(0,3);
      const titles = ['é–ƒé›»æ‰‹ âš¡','é£›è»Šæ‰‹ ğŸï¸','è³½é“ç‹ ğŸ'];
      leaderboardDiv.innerHTML = '<b>æ’è¡Œæ¦œ (å‰3å):</b><br>' + sorted.map((r,i)=>`ç¬¬${i+1}å (${titles[i]||''}): ${r} ms`).join('<br>');
    }
    function updateAll(){ updateHistory(); updateAverage(); updateBest(); updateLeaderboard(); }

    // ======== ç‡ˆè™Ÿå»ºç«‹/é‡ç½® ========
    function createLights(){
      lightsContainer.innerHTML='';
      columns = [];
      for (let c=0;c<5;c++){
        const colDiv = document.createElement('div'); colDiv.className='col';
        const colLights = [];
        for (let r=0;r<4;r++){
          const d = document.createElement('div'); d.className='light';
          colDiv.appendChild(d); colLights.push(d);
        }
        lightsContainer.appendChild(colDiv); columns.push(colLights);
      }
    }
    function resetLights(){ columns.forEach(col=>col.forEach(l=>l.classList.remove('on','go'))); }
    function clearTimers(){
      if (buildInterval){ clearInterval(buildInterval); buildInterval=null; }
      if (preGoTimeout){ clearTimeout(preGoTimeout); preGoTimeout=null; }
      if (flashInterval){ clearInterval(flashInterval); flashInterval=null; }
    }

    // ======== æµç¨‹æ§åˆ¶ ========
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function startGame(mode='single'){
      // é˜²æŠ–
      startBtn.disabled = true; tripleBtn.disabled = true;

      clearTimers(); resetLights();
      message.textContent = 'ç‡ˆè™Ÿæº–å‚™ä¸­... è«‹ç­‰å¾…';
      startSound.currentTime=0; startSound.play();

      const diff = DIFF[difficultySel.value] || DIFF.normal;
      waiting = false; gameActive = true; tripleMode = (mode==='triple');
      if (tripleMode && !tripleBuffer.length){
        tripleSummary.innerHTML = '<b>ä¸‰é€£æŒ‘æˆ°ï¼š</b>é€²è¡Œä¸­ (0/3)';
      }

      let colIdx = 0;
      buildInterval = setInterval(()=>{
        if (colIdx < columns.length){
          columns[colIdx].forEach(l=>l.classList.add('on'));
          colIdx++;
        }else{
          clearInterval(buildInterval); buildInterval=null;
          const delay = randInt(diff.delayMin, diff.delayMax);
          preGoTimeout = setTimeout(()=>{
            resetLights();
            columns.forEach(col=>col.forEach(l=>l.classList.add('go')));
            message.textContent = 'GOï¼å¿«æŒ‰ä¸‹ç©ºç™½éµæˆ–é»æ“Šè¢å¹•ï¼';
            goSound.currentTime=0; goSound.play();
            startTime = Date.now(); waiting = true;
            // ç¶ ç‡ˆé–ƒçˆï¼ˆè¦–è¦ºï¼‰
            flashInterval = setInterval(()=>{
              columns.forEach(col=>col.forEach(l=>l.classList.toggle('go')));
            }, 280);
            setTimeout(()=>{ clearInterval(flashInterval); flashInterval=null; }, 2000);
          }, delay);
        }
      }, diff.colInterval);
    }

    function endGame(){
      if (!waiting) return; // å°šæœª GO
      const reaction = Date.now() - startTime;
      waiting=false; gameActive=false;
      results.push(reaction); attempts.push({type:'time', value:reaction});

      const nickname = nicknameInput.value || 'ç©å®¶';
      message.textContent = `${nickname} çš„åæ‡‰æ™‚é–“: ${reaction} ms - ${getComment(reaction)}`;

      // ä¸‰é€£æ¨¡å¼
      if (tripleMode){
        tripleBuffer.push(reaction);
        const done = tripleBuffer.length;
        if (done < 3){
          tripleSummary.innerHTML = `<b>ä¸‰é€£æŒ‘æˆ°ï¼š</b>é€²è¡Œä¸­ (${done}/3)ï¼Œè«‹ç¹¼çºŒï¼`;
          setTimeout(()=> startGame('triple'), 900);
        }else{
          const sum = tripleBuffer.reduce((a,b)=>a+b,0);
          const avg = Math.round(sum/3);
          const best = Math.min(...tripleBuffer);
          const remark = getComment(avg);
          tripleSummary.innerHTML = `<b>ä¸‰é€£æŒ‘æˆ°å®Œæˆï¼</b><br>ä¸‰æ¬¡ï¼š${tripleBuffer.join(' / ')} ms<br>å¹³å‡ï¼š${avg} msï¼Œæœ€ä½³ï¼š${best} ms<br>ç¸½è©•ï¼š${remark}`;
          tripleBuffer=[]; tripleMode=false; startBtn.disabled=false; tripleBtn.disabled=false;
        }
      }else{
        startBtn.disabled=false; tripleBtn.disabled=false;
      }

      shareBtn.style.display='inline-block';
      updateAll(); saveLocal();
    }

    function falseStart(){
      if (!gameActive || waiting) return; // éç‡ˆè™ŸæœŸæˆ–å·² GO ä¸ç®—
      falseStartSound.currentTime=0; falseStartSound.play();
      clearTimers(); resetLights(); waiting=false; gameActive=false;
      attempts.push({type:'fs'});
      message.innerHTML = `<span class="fs">æ¶è·‘ï¼æ­¤è¼ªä¸è¨ˆå…¥æˆç¸¾ï¼Œè«‹é‡æ–°é–‹å§‹ã€‚</span>`;
      if (tripleMode){ tripleBuffer=[]; tripleSummary.innerHTML = '<b>ä¸‰é€£æŒ‘æˆ°ï¼š</b>æ¶è·‘ï¼Œå·²é‡ç½® (0/3)'; }
      startBtn.disabled=false; tripleBtn.disabled=false;
      updateHistory(); saveLocal();
    }

    // ======== åˆ†äº«åœ–å¡ ========
    function parseSize(v){ const [w,h]=v.split('x').map(n=>parseInt(n,10)); return {w,h}; }
    function buildShareCard({w,h}){
      const nickname = nicknameInput.value || 'ç©å®¶';
      const last = attempts.length && attempts[attempts.length-1].type==='time' ? attempts[attempts.length-1].value : null;
      const avgText = averageDiv.textContent.replace('å¹³å‡åæ‡‰æ™‚é–“: ','');
      const bestText = bestDiv.textContent.replace('æœ€ä½³åæ‡‰æ™‚é–“: ','');
      const top3 = (results.length? [...results].sort((a,b)=>a-b).slice(0,3):[]).map((r,i)=>`#${i+1} ${r}ms`).join('  ');
      const today = new Date();
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      const comment = last? getComment(last):'';
      const rank = last? getRank(last):{title:'',badge:''};

      shareCardWrapper.innerHTML='';
      const card = document.createElement('div'); card.className='share-card';
      card.style.width=w+'px'; card.style.height=h+'px';
      card.style.backgroundImage = getComputedStyle(document.body).backgroundImage;

      const top = document.createElement('div'); top.className='share-top';
      const lights = document.createElement('div'); lights.className='share-lights';
      for(let i=0;i<5;i++){ const d=document.createElement('div'); d.className='share-light'; lights.appendChild(d); }
      const title = document.createElement('div'); title.className='share-title'; title.textContent='F1 åæ‡‰é€Ÿåº¦è¨“ç·´';
      top.appendChild(lights); top.appendChild(title);

      const mid = document.createElement('div'); mid.className='share-mid';
      const big = document.createElement('div'); big.className='share-big'; big.textContent = last? `${last} ms` : 'â€”';
      const sub = document.createElement('div'); sub.className='share-sub'; sub.textContent = `${nickname}ï½œå¹³å‡ ${avgText}ï½œæœ€ä½³ ${bestText}`;
      const rankEl = document.createElement('div'); rankEl.className='share-rank'; rankEl.innerHTML = `${rank.badge} ${rank.title}`;
      const cmt = document.createElement('div'); cmt.className='share-sub'; cmt.textContent = comment;

      const grid = document.createElement('div'); grid.className='share-grid';
      const b1 = document.createElement('div'); b1.className='share-box'; b1.innerHTML = `<b>æ’è¡Œæ¦œå‰ 3</b><br>${top3||'â€”'}`;
      const b2 = document.createElement('div'); b2.className='share-box'; b2.innerHTML = `<b>æ¨¡å¼ / é›£åº¦</b><br>${difficultySel.options[difficultySel.selectedIndex].text}`;
      grid.appendChild(b1); grid.appendChild(b2);

      const rankListBox = document.createElement('div'); rankListBox.className='ranklist-box';
      rankListBox.innerHTML = `<b>æ®µä½åˆ—è¡¨ï¼š</b><br>
        âš¡ é–ƒé›»æ‰‹ï¼š<200ms<br>
        ğŸï¸ é£›è»Šæ‰‹ï¼š200â€“299ms<br>
        ğŸ¯ å°ˆæ³¨è€…ï¼š300â€“399ms<br>
        ğŸš¦ æ–°æ‰‹ï¼š400â€“599ms<br>
        ğŸ¢ æ…¢åŠæ‹ï¼šâ‰¥600ms`;

      mid.appendChild(big); mid.appendChild(sub); mid.appendChild(rankEl); mid.appendChild(cmt); mid.appendChild(grid); mid.appendChild(rankListBox);

      const foot = document.createElement('div'); foot.className='share-foot';
      const flag = document.createElement('div'); flag.className='checker';
      const dateEl = document.createElement('div'); dateEl.textContent = dateStr;
      foot.appendChild(flag); foot.appendChild(dateEl);

      card.appendChild(top); card.appendChild(mid); card.appendChild(foot);
      shareCardWrapper.appendChild(card);
      return card;
    }
    function downloadCard(node, filename, {w,h}){
      html2canvas(node, {width:w, height:h, windowWidth:w, windowHeight:h, backgroundColor:null, scale:1}).then(canvas=>{
        const link=document.createElement('a'); link.download=filename; link.href=canvas.toDataURL('image/png'); link.click();
      });
    }

    // ======== äº‹ä»¶ç¹«çµ ========
    function clickIsControl(target){
      return [startBtn,tripleBtn,shareBtn,resetBtn,difficultySel,nicknameInput,shareSizeSel].some(el=> el && (target===el || el.contains(target)) );
    }

    startBtn.addEventListener('click', ()=> startGame('single'));
    tripleBtn.addEventListener('click', ()=>{ tripleBuffer=[]; tripleMode=true; startGame('triple'); });
    resetBtn.addEventListener('click', ()=>{
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬åœ°æˆç¸¾èˆ‡æ­·å²å—ï¼Ÿ')) return;
      results=[]; attempts=[]; tripleBuffer=[]; tripleMode=false; waiting=false; gameActive=false;
      clearTimers(); resetLights(); updateAll(); saveLocal();
      message.textContent='è³‡æ–™å·²æ¸…é™¤ã€‚';
    });
    shareBtn.addEventListener('click', ()=>{
      const {w,h} = parseSize(shareSizeSel.value);
      const node = buildShareCard({w,h});
      const nickname = nicknameInput.value || 'ç©å®¶';
      downloadCard(node, `${nickname}_reaction_${w}x${h}.png`, {w,h});
    });

    document.body.addEventListener('keydown', e=>{
      if (e.code !== 'Space') return;
      if (waiting) return endGame();
      if (gameActive) return falseStart();
    });
    document.body.addEventListener('click', e=>{
      if (clickIsControl(e.target)) return;
      if (waiting) return endGame();
      if (gameActive) return falseStart();
    });

    // ======== åˆå§‹åŒ– ========
    loadLocal();
    createLights();
    updateAll();
    updateRankList();
  </script>
</body>
</html>

