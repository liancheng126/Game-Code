<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Snake 貪吃蛇</title>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #14182b;
      --accent: #5cf2a6;
      --accent-2: #6aa8ff;
      --danger: #ff6b6b;
      --grid: #1e2340;
      --text: #e9edf8;
      --muted: #9aa3b2;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overscroll-behavior: none; }
    body {
      margin: 0; background: radial-gradient(1200px 800px at 10% 10%, #151936 0%, var(--bg) 45%),
                  radial-gradient(1000px 800px at 90% 10%, #182042 0%, var(--bg) 50%),
                  var(--bg);
      color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial, sans-serif;
      display: grid; place-items: center; padding: 12px; min-height: 100dvh; overflow: hidden;
    }
    .card {
      width: min(94vw, 960px);
      height: calc(100dvh - 24px);
      background: linear-gradient(180deg, #161c38 0%, #0e1330 100%);
      border: 1px solid #1e2449; border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
      padding: 10px 12px; position: relative; overflow: hidden;
      display: flex; flex-direction: column; gap: 8px;
    }
    header {
      display: flex; flex-wrap: wrap; align-items: center; gap: 8px; row-gap: 6px; justify-content: space-between;
      border-bottom: 1px dashed #26305e; padding-bottom: 8px;
    }
    .title { display:flex; align-items:center; gap:8px; min-width: 200px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: .5px; }
    .credit { font-size: 12px; color: var(--muted); }
    .stats { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill { background: #101535; border: 1px solid #2a376d; color: var(--text); padding: 6px 10px; border-radius: 999px; font-size: 12px; min-width: 88px; text-align: center; }
    .pill strong { color: var(--accent); }
    .controls { display: flex; gap: 6px; flex-wrap: wrap; }
    button {
      appearance: none; border: 1px solid #2a376d; background: #0e1433; color: var(--text); cursor: pointer;
      padding: 8px 10px; border-radius: 10px; font-weight: 600; letter-spacing: .2px; font-size: 13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { background: #111a44; }
    button:active { transform: translateY(1px); }
    .primary { border-color: #2b6f66; background: linear-gradient(180deg, #0c2b27, #0b1f1d); }
    .danger { border-color: #5a2634; background: linear-gradient(180deg, #2b0c16, #1d0b11); }

    .lb { display:flex; align-items:center; gap:8px; min-width: 260px; }
    .list { margin:0; padding: 6px 10px; border: 1px dashed #26305e; border-radius: 12px; font-size: 12px; color: var(--muted); max-width: 100%; }
    .list ol { margin: 6px 0 0 18px; }

    .main { flex: 1; display: grid; grid-template-rows: 1fr auto; gap: 8px; min-height: 0; }
    .board { position: relative; width: 100%; height: 100%; background: #0b102a; border-radius: 16px; overflow: hidden; border: 1px solid #1b2348; box-shadow: inset 0 0 0 1px rgba(255,255,255,.03); }
    canvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }

    .overlay {
      position: absolute; inset: 0; display: none; align-items: center; justify-content: center; flex-direction: column;
      background: radial-gradient(400px 300px at 50% 40%, rgba(20,25,60,.7), rgba(10,14,35,.85));
      color: var(--text); text-align: center; padding: 24px; gap: 14px; cursor: pointer;
      touch-action: manipulation;
    }
    .overlay.show { display: flex; }
    .overlay h2 { margin: 0; font-size: 22px; }
    .hint { font-size: 12px; color: var(--muted); }

    /* Glow Joystick */
    .joystick { position: fixed; left: 50%; bottom: max(16px, env(safe-area-inset-bottom)); transform: translateX(-50%);
      width: 140px; height: 140px; border-radius: 50%;
      background: radial-gradient(60% 60% at 50% 45%, #10183e 0%, #0c1333 60%, #0a0f2c 100%);
      border: 2px solid #2a376d; box-shadow: 0 0 25px rgba(106,168,255,.25), inset 0 0 18px rgba(92,242,166,.12);
      touch-action: none; user-select: none; overflow: visible; z-index: 20; display:none;
    }
    .joystick::before { content: ""; position: absolute; inset: -6px; border-radius: 50%; background: conic-gradient(from 0deg, rgba(106,168,255,.0), rgba(106,168,255,.45), rgba(92,242,166,.45), rgba(106,168,255,.0)); filter: blur(10px); opacity: .8; pointer-events: none; }
    .stick { position: absolute; left: 50%; top: 50%; width: 64px; height: 64px; border-radius: 50%; transform: translate(-50%, -50%);
      background: radial-gradient(70% 70% at 40% 35%, #7bf7bf 0%, #5cf2a6 40%, #39c18a 100%); box-shadow: 0 0 22px rgba(92,242,166,.65), inset 0 8px 16px rgba(255,255,255,.2); border: 2px solid rgba(92,242,166,.7); transition: transform .05s linear; pointer-events: none; }
  @media (hover: none), (pointer: coarse) {
    .joystick { display:block; }
  }
  @media (min-width: 900px) {
    .joystick { display:none; }
  }
</style>
</head>
<body>
  <div class="card" id="card">
    <header id="header">
      <div class="title">
        <h1>Snake 貪吃蛇</h1>
        <div class="credit">創作者：LIAN CHENG｜方向鍵 / WASD / 搖桿</div>
      </div>
      <div class="stats">
        <div class="pill">分數：<strong id="score">0</strong></div>
        <div class="pill">最佳：<strong id="best">0</strong></div>
      </div>
      <div class="controls">
        <button id="startBtn" class="primary">開始</button>
        <button id="restartBtn" class="danger">重玩</button>
        <button id="shareBtn">分享成績</button>
      </div>
      <div class="lb">
        <div class="list">
          高分紀錄（前五）
          <ol id="lb"></ol>
        </div>
      </div>
    </header>

    <div class="main">
      <div class="board" id="board">
        <canvas id="game" width="600" height="600" aria-label="遊戲畫布"></canvas>
        <div id="overlay" class="overlay" role="dialog" aria-live="polite">
          <h2 id="overlayTitle">點這裡或按「開始」開始遊戲</h2>
          <div class="hint">操作：方向鍵 / WASD / 下方發光搖桿</div>
          <div>
            <button id="resumeBtn" class="primary">開始</button>
            <button id="againBtn">重玩</button>
          </div>
        </div>
      </div>
      <!-- 下面保留一個 0 高度列，確保 grid 可伸展 -->
      <div style="height:0"></div>
    </div>
  </div>

  <div class="joystick" id="joystick"><div class="stick" id="stick"></div></div>

  <script>
    ;(() => {
      'use strict'
      // ======= DOM =======
      const card = document.getElementById('card')
      const header = document.getElementById('header')
      const boardEl = document.getElementById('board')
      const canvas = document.getElementById('game')
      const ctx = canvas.getContext('2d', { alpha: false })
      const scoreEl = document.getElementById('score')
      const bestEl = document.getElementById('best')
      const overlay = document.getElementById('overlay')
      const overlayTitle = document.getElementById('overlayTitle')
      const startBtn = document.getElementById('startBtn')
      const restartBtn = document.getElementById('restartBtn')
      const resumeBtn = document.getElementById('resumeBtn')
      const againBtn = document.getElementById('againBtn')
      const shareBtn = document.getElementById('shareBtn')
      const joystick = document.getElementById('joystick')
      const stick = document.getElementById('stick')
      const lbEl = document.getElementById('lb')

      const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1))

      // ======= Config =======
      const COLS = 20, ROWS = 20
      const SPEED_BASE = 7, SPEED_INC = 0.3, SPEED_CAP = 20
      const BG = '#0b102a', GRID = '#13193a', SNAKE_HEAD = '#5cf2a6', SNAKE_BODY = '#72f9b6', FOOD = '#6aa8ff'

      // ======= Storage (safe) =======
      const memStore = {}
      const sget=(k,d)=>{ try{ const v=localStorage.getItem(k); return v==null?d:v }catch{ return memStore[k]??d } }
      const sset=(k,v)=>{ try{ localStorage.setItem(k,v) }catch{ memStore[k]=v } }

      // ======= Layout: ensure full board visible =======
      function layoutBoard(){
        const gap = 8
        const availH = Math.max(0, card.clientHeight - header.offsetHeight - gap)
        const availW = boardEl.clientWidth
        const size = Math.max(0, Math.min(availW, availH))
        boardEl.style.height = size + 'px'
        const w = (size|0) * DPR
        if (canvas.width !== w || canvas.height !== w) {
          canvas.width = w; canvas.height = w
          ctx.setTransform(DPR,0,0,DPR,0,0)
        }
      }
      const ro1 = new ResizeObserver(layoutBoard); ro1.observe(card); ro1.observe(boardEl)
      window.addEventListener('resize', layoutBoard)

      // ======= Leaderboard =======
      const loadLB=()=>{ try { return JSON.parse(sget('snake_lb','[]')) } catch { return [] } }
      const saveLB=a=>sset('snake_lb', JSON.stringify(a))
      const addToLB=sc=>{ const a=loadLB(); a.push({score:sc, ts:Date.now()}); a.sort((x,y)=>y.score-x.score); saveLB(a.slice(0,20)) }
      const renderLB=()=>{ const a=loadLB().slice(0,5); lbEl.innerHTML=a.map(e=>`<li>${e.score} 分 · <span style="opacity:.7">${new Date(e.ts).toLocaleString()}</span></li>`).join('') }

      // ======= State Machine =======
      const State={ idle:'idle', running:'running', paused:'paused', dead:'dead' }
      let state=State.idle, snake, dir, nextDir, food, score, best, speed
      let last=0, acc=0

      const updateUI=()=>{
        startBtn.textContent = state===State.running? '暫停' : state===State.paused? '繼續' : '開始'
        if (state===State.idle){ overlayTitle.textContent='點這裡或按「開始」開始遊戲'; overlay.classList.add('show') }
        else if (state===State.paused){ overlayTitle.textContent='已暫停（點擊空白處繼續）'; overlay.classList.add('show') }
        else if (state===State.dead){ overlayTitle.textContent=`遊戲結束！分數：${score}（點擊空白處繼續）`; overlay.classList.add('show') }
        else overlay.classList.remove('show')
      }
      const setState=(ns)=>{ state=ns; updateUI() }

      function reset(){ snake=[{x:8,y:10},{x:7,y:10},{x:6,y:10}]; dir={x:1,y:0}; nextDir={x:1,y:0}; score=0; speed=SPEED_BASE; placeFood(); last=0; acc=0; best=Math.max(Number(sget('snake_best',0)),0); scoreEl.textContent='0'; bestEl.textContent=best }
      const hardReset=()=>{ reset(); setState(State.idle); step() }
      const updateScore=()=>{ scoreEl.textContent=score; if(score>best){ best=score; sset('snake_best', String(best)); bestEl.textContent=best } }
      function placeFood(){ const set=new Set(snake.map(s=>s.x+':'+s.y)); let x,y; do{ x=(Math.random()*COLS)|0; y=(Math.random()*ROWS)|0 } while(set.has(x+':'+y)); food={x,y} }

      // ======= Render =======
      function drawGrid(w,h,cell){ ctx.fillStyle=BG; ctx.fillRect(0,0,w,h); ctx.strokeStyle=GRID; ctx.lineWidth=1; for(let x=0;x<=w;x+=cell){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,h); ctx.stroke() } for(let y=0;y<=h;y+=cell){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(w,y+0.5); ctx.stroke() } }
      const drawCell=(x,y,cell,color)=>{ const pad=Math.max(1,(cell*0.12)|0); ctx.fillStyle=color; ctx.fillRect(x*cell+pad,y*cell+pad,cell-pad*2,cell-pad*2) }
      function step(){ const w=canvas.width/DPR, h=canvas.height/DPR, cell=Math.floor(Math.min(w/COLS,h/ROWS)), bw=cell*COLS, bh=cell*ROWS; ctx.save(); ctx.translate((w-bw)/2,(h-bh)/2); drawGrid(bw,bh,cell); drawCell(food.x,food.y,cell,FOOD); for(let i=0;i<snake.length;i++){ const s=snake[i]; drawCell(s.x,s.y,cell,i?SNAKE_BODY:SNAKE_HEAD) } ctx.restore() }

      // ======= Game Loop =======
      function loop(ts){ if(state!==State.running) return; if(!last) last=ts; let dt=(ts-last)/1000; last=ts; if(dt>0.25) dt=0.25; acc+=dt; const stepTime=1/Math.min(speed,SPEED_CAP); let guard=0; while(acc>=stepTime && guard<8){ tick(); acc-=stepTime; guard++ } step(); requestAnimationFrame(loop) }
      function tick(){ if(!(nextDir.x===-dir.x && nextDir.y===-dir.y)) dir=nextDir; const head={x:snake[0].x+dir.x, y:snake[0].y+dir.y}; if(head.x<0||head.x>=COLS||head.y<0||head.y>=ROWS||snake.some(s=>s.x===head.x&&s.y===head.y)) return die(); snake.unshift(head); if(head.x===food.x&&head.y===food.y){ score++; speed+=SPEED_INC; updateScore(); placeFood() } else snake.pop() }
      function die(){ setState(State.dead); addToLB(score); renderLB() }

      // ======= Controls =======
      function startGame(){ if(state===State.idle){ overlay.classList.remove('show'); setState(State.running); last=0; acc=0; requestAnimationFrame(loop) } }
      function resumeGame(){ if(state===State.paused){ overlay.classList.remove('show'); setState(State.running); last=0; requestAnimationFrame(loop) } }
      function pauseGame(){ if(state===State.running){ setState(State.paused) } }
      function handleStartClick(){ if(state===State.running) return pauseGame(); if(state===State.idle) return startGame(); if(state===State.paused) return resumeGame(); if(state===State.dead){ reset(); return startGame() } }

      const keyMap={ ArrowUp:{x:0,y:-1}, KeyW:{x:0,y:-1}, ArrowDown:{x:0,y:1}, KeyS:{x:0,y:1}, ArrowLeft:{x:-1,y:0}, KeyA:{x:-1,y:0}, ArrowRight:{x:1,y:0}, KeyD:{x:1,y:0} }
      window.addEventListener('keydown', e=>{ const c=e.code; if(keyMap[c]){ e.preventDefault(); nextDir=keyMap[c] } else if(c==='Space'||c==='Enter'){ e.preventDefault(); handleStartClick() } }, {passive:false})

      overlay.addEventListener('click', e=>{ if(e.target===overlay){ if(state===State.idle) startGame(); else if(state===State.paused) resumeGame(); else if(state===State.dead){ reset(); startGame() } } })
      resumeBtn.addEventListener('click', e=>{ e.stopPropagation(); handleStartClick() })
      againBtn.addEventListener('click', e=>{ e.stopPropagation(); hardReset(); startGame() })
      startBtn.addEventListener('click', e=>{ e.preventDefault(); handleStartClick() })
      restartBtn.addEventListener('click', e=>{ e.preventDefault(); hardReset() })
      canvas.addEventListener('pointerdown', ()=>{ if(state!==State.running) handleStartClick() })
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden) pauseGame() })

      // ======= Joystick =======
      let centerX=0, centerY=0, radius=0, joyActive=false
      function cacheJoy(){ const r=joystick.getBoundingClientRect(); centerX=r.left+r.width/2; centerY=r.top+r.height/2; radius=r.width/2-6 }
      const setStick=(dx,dy)=>{ const len=Math.hypot(dx,dy), max=radius, ang=len?Math.atan2(dy,dx):0, r=Math.min(len,max), x=r*Math.cos(ang), y=r*Math.sin(ang); stick.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`; if(Math.abs(dx)>Math.abs(dy)) nextDir={x:dx>0?1:-1,y:0}; else if(Math.abs(dy)>Math.abs(dx)) nextDir={x:0,y:dy>0?1:-1} }
      const resetStick=()=>{ stick.style.transform='translate(-50%, -50%)' }
      const joyDown=(x,y)=>{ joyActive=true; cacheJoy(); setStick(x-centerX,y-centerY); if(state!==State.running) handleStartClick() }
      const joyMove=(x,y)=>{ if(joyActive) setStick(x-centerX,y-centerY) }
      const joyUp=()=>{ joyActive=false; resetStick() }

      joystick.addEventListener('pointerdown', e=>{ joystick.setPointerCapture?.(e.pointerId); joyDown(e.clientX,e.clientY) })
      joystick.addEventListener('pointermove', e=>{ if(joyActive){ e.preventDefault(); joyMove(e.clientX,e.clientY) } }, {passive:false})
      joystick.addEventListener('pointerup', joyUp)
      joystick.addEventListener('pointercancel', joyUp)
      joystick.addEventListener('lostpointercapture', joyUp)
      window.addEventListener('touchmove', e=>{ if(joyActive) e.preventDefault() }, {passive:false})
      joystick.addEventListener('touchstart', e=>{ const t=e.touches[0]; joyDown(t.clientX,t.clientY) }, {passive:true})
      joystick.addEventListener('touchmove', e=>{ const t=e.touches[0]; if(joyActive){ e.preventDefault(); joyMove(t.clientX,t.clientY) } }, {passive:false})
      joystick.addEventListener('touchend', joyUp)

      // ======= Share (1080x1920) =======
      function roundRect(g,x,y,w,h,r){ g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath() }
      function drawShareCard(score, best){ const W=1080,H=1920,c=document.createElement('canvas'); c.width=W; c.height=H; const g=c.getContext('2d'); const grad=g.createLinearGradient(0,0,0,H); grad.addColorStop(0,'#0e1330'); grad.addColorStop(.5,'#10183e'); grad.addColorStop(1,'#0b102a'); g.fillStyle=grad; g.fillRect(0,0,W,H); g.globalAlpha=.35; g.fillStyle='#6aa8ff'; g.beginPath(); g.arc(200,300,260,0,Math.PI*2); g.fill(); g.fillStyle='#5cf2a6'; g.beginPath(); g.arc(900,620,320,0,Math.PI*2); g.fill(); g.globalAlpha=1; g.fillStyle='#e9edf8'; g.font='700 72px system-ui, Noto Sans TC'; g.fillText('Snake 貪吃蛇',80,160); g.font='400 32px system-ui, Noto Sans TC'; g.fillStyle='#9aa3b2'; g.fillText('創作者：LIAN CHENG',80,210); g.fillStyle='#101535'; g.strokeStyle='#2a376d'; g.lineWidth=4; const bx=80,by=270,bw=W-160,bh=420; roundRect(g,bx,by,bw,bh,28); g.fill(); g.stroke(); g.font='600 44px system-ui, Noto Sans TC'; g.fillStyle='#9aa3b2'; g.fillText('本局分數',bx+40,by+80); g.font='800 180px system-ui, Noto Sans TC'; g.fillStyle='#5cf2a6'; g.fillText(String(score),bx+40,by+260); g.font='600 44px system-ui, Noto Sans TC'; g.fillStyle='#9aa3b2'; g.fillText('最佳紀錄',bx+40,by+340); g.font='800 80px system-ui, Noto Sans TC'; g.fillStyle='#6aa8ff'; g.fillText(String(best),bx+260,by+340); g.globalAlpha=.85; g.fillStyle='#9aa3b2'; g.font='400 32px system-ui, Noto Sans TC'; g.fillText(new Date().toLocaleString(),80,H-120); g.globalAlpha=1; return c }
      async function shareCurrentScore(){ const card=drawShareCard(score,best); if(navigator.canShare&&navigator.share&&card.toBlob){ await new Promise(res=>card.toBlob(res,'image/png')).then(async blob=>{ if(!blob) throw 0; const file=new File([blob],`snake_${score}.png`,{type:'image/png'}); if(navigator.canShare({files:[file]})) return navigator.share({files:[file],title:'Snake 貪吃蛇 成績',text:`我在 Snake 得到 ${score} 分！最佳 ${best} 分。`}); const url=URL.createObjectURL(blob); window.open(url,'_blank') }).catch(()=>{ const url=card.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`snake_${score}.png`; a.click() }) } else { const url=card.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`snake_${score}.png`; a.click() } }
      shareBtn.addEventListener('click', e=>{ e.preventDefault(); e.stopPropagation(); shareCurrentScore() })

      // ======= Boot =======
      function init(){ layoutBoard(); hardReset(); renderLB(); overlay.classList.add('show') }
      init(); step()
    })()
  </script>
</body>
</html>
